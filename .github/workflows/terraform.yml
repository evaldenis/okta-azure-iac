name: Terraform CI/CD

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - 'app/**'
      - '.github/workflows/terraform.yml'
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - 'app/**'
      - '.github/workflows/terraform.yml'

env:
  TF_VERSION: '1.6.0'
  WORKING_DIR: './terraform'

jobs:
  terraform-validate:
    name: Terraform Validation & Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          terraform fmt -check -recursive
          echo "format_result=$?" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        id: tflint
        run: |
          tflint --init
          tflint --format compact
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true

      - name: Security Scan with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.WORKING_DIR }}
          framework: terraform
          output_format: cli
          soft_fail: true

      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}
        env:
          # Terraform variables
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_azure_resource_group: ${{ secrets.AZURE_RESOURCE_GROUP }}
          # Azure backend authentication
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ env.WORKING_DIR }}
        env:
          # Terraform variables
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_azure_resource_group: ${{ secrets.AZURE_RESOURCE_GROUP }}
        continue-on-error: true

      - name: Create Validation Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fmtResult = '${{ steps.fmt.outcome }}';
            const tflintResult = '${{ steps.tflint.outcome }}';
            const checkovResult = '${{ steps.checkov.outcome }}';
            const initResult = '${{ steps.init.outcome }}';
            const validateResult = '${{ steps.validate.outcome }}';

            const getEmoji = (result) => result === 'success' ? '✅' : result === 'failure' ? '❌' : '⚠️';

            const output = `## Terraform CI/CD Results

            | Check | Result |
            |-------|--------|
            | Format | ${getEmoji(fmtResult)} \`${fmtResult}\` |
            | TFLint | ${getEmoji(tflintResult)} \`${tflintResult}\` |
            | Security Scan | ${getEmoji(checkovResult)} \`${checkovResult}\` |
            | Init | ${getEmoji(initResult)} \`${initResult}\` |
            | Validate | ${getEmoji(validateResult)} \`${validateResult}\` |

            ### Summary

            ${fmtResult === 'success' ? '✅' : '❌'} **Code Formatting**: ${fmtResult === 'success' ? 'Passed' : 'Failed - Run `terraform fmt -recursive`'}
            ${tflintResult === 'success' ? '✅' : '⚠️'} **Linting**: ${tflintResult === 'success' ? 'Passed' : 'Issues found'}
            ${checkovResult === 'success' ? '✅' : '⚠️'} **Security**: ${checkovResult === 'success' ? 'No issues' : 'Review required'}
            ${validateResult === 'success' ? '✅' : '⚠️'} **Validation**: ${validateResult === 'success' ? 'Configuration valid' : 'Check syntax'}

            ---

            *Pusher: @${{ github.actor }} | Event: \`${{ github.event_name }}\`*

            **Note:** This workflow validates infrastructure code. Manual deployment required via \`terraform apply\`.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Workflow Status
        if: always()
        run: |
          echo "=== Terraform CI/CD Summary ==="
          echo "Format Check: ${{ steps.fmt.outcome }}"
          echo "TFLint: ${{ steps.tflint.outcome }}"
          echo "Security Scan: ${{ steps.checkov.outcome }}"
          echo "Init: ${{ steps.init.outcome }}"
          echo "Validate: ${{ steps.validate.outcome }}"
          echo "=============================="
